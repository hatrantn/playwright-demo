name: Playwright Tests

# Allow public users to trigger workflows
permissions:
  contents: read
  actions: write
  pull-requests: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - register
          - login
          - search
          - filter-products
          - forgot-password
      test_grep:
        description: 'Test pattern to match (e.g., "Sorting", "Login", etc.)'
        required: false
        default: ''
        type: string
      browser:
        description: 'Browser to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
          - edge
          - 'Mobile Chrome'
          - 'Mobile Safari'
      headed:
        description: 'Run in headed mode'
        required: false
        default: false
        type: boolean
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Show manual trigger info
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "ðŸš€ Manual Trigger Configuration:"
        echo "Test Suite: ${{ github.event.inputs.test_suite }}"
        echo "Browser: ${{ github.event.inputs.browser }}"
        echo "Headed Mode: ${{ github.event.inputs.headed }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Public access: âœ… Enabled"
    - name: Run Playwright tests
      run: |
        # Build test command based on inputs
        TEST_CMD="npx playwright test"
        
        # On push events, run Chromium only by default
        if [ "${{ github.event_name }}" = "push" ]; then
          TEST_CMD="$TEST_CMD --project=chromium"
        fi
        
        # Add test suite filter if specified
        if [ "${{ github.event.inputs.test_suite }}" != "all" ] && [ "${{ github.event.inputs.test_suite }}" != "" ]; then
          TEST_CMD="$TEST_CMD tests/${{ github.event.inputs.test_suite }}.spec.ts"
        fi
        
        # Add browser filter if specified (not on push, which defaults to Chromium)
        if [ "${{ github.event_name }}" != "push" ] && [ "${{ github.event.inputs.browser }}" != "all" ] && [ "${{ github.event.inputs.browser }}" != "" ]; then
          TEST_CMD="$TEST_CMD --project=${{ github.event.inputs.browser }}"
        fi
        
        # Add headed mode if specified (default is headless)
        if [ "${{ github.event.inputs.headed }}" == "true" ]; then
          TEST_CMD="$TEST_CMD --headed"
        fi
        # Note: When --headed is not specified, Playwright runs in headless mode by default
        
        # Run the test command
        echo "Running: $TEST_CMD"
        eval $TEST_CMD
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
